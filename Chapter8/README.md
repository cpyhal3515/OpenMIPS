# 第八章：转移指令的实现
## 1、延迟槽
分支延迟槽 (Branch delay slot)，简单地说就是位于分支指令后面的一条指令，不管分支发生与否其总是被执行，而且位于分支延迟槽中的指令先于分支指令提交 (commit)。
* 引入分支延迟槽的目的主要是为了提高流水线的效率: 流水线中，分支指令执行时因为确定下一条指令的目标地址（紧随其后 or 跳转目标处？）一般要到第 2 级以后，在目标确定前流水线的取指级是不能工作的，即整个流水线就“浪费”（阻塞）了一个时间片，为了利用这个时间片，在体系结构的层面上规定跳转指令后面的一个时间片为分支延迟槽（branch delay slot）。位于分支延迟槽中的指令总是被执行，与分支发生与否没有关系。这样就有效利用了一个时间片，消除了流水线的一个“气泡”。

这种技术手段主要用在早期没有分支预测的流水线 RISC 上，现代 RISC 实现早就可以在流水线的第 2 级利用分支预测确定跳转的目标，分支延迟槽也就失去了原来的价值，但为了软件上的兼容性 MIPS 和 SPARC 还是作了保留。

## 2、转移/分支指令的说明
### （1）跳转指令
<div align=center><img src=./Picture/1.png width = 50% ></div>

* jr 指令：`jr rs`，将地址为rs的通用寄存器的值赋给寄存器PC，作为新的指令地址。
* jalr 指令：`jalr rs 或 jalr rd, rs`，相比于 jr 指令除了跳转外，还同时将跳转指令后面第2条指令的地址作为返回地址保存到地址为 rd 的通用寄存器中，没有指明 rd 则默认将返回地址保存到寄存器 $31 中。
* j 指令：`j target` 转移到新的指令地址，其中新指令地址的低28位是指令中的target（也就是图中的instr_index）左移两位的值，新指令地址的高4位是跳转指令后面延迟槽指令的地址高4位。
* jal 指令：`jal target` 相比于 j 指令，jal 除了跳转，还同时将跳转指令后面第2条指令的地址作为返回地址保存到地址为 $31 的通用寄存器中。

### （2）分支指令
<div align=center><img src=./Picture/2.png width = 50% ></div>

* beq 指令：`beq rs, rt, offset` 将地址为 rs 的通用寄存器的值与地址为 rt 的通用寄存器的值进行比较，如果相等，那么发生转移。
* b 指令：`b offset`，看图可知 b 指令是 beq 指令的特殊形式，因此不需要单独实现。
* bgtz 指令：`bgtz rs, offset` 如果地址为 rs 的通用寄存器的值大于零，那么发生转移。
* blez 指令：`blez rs, offset` 如果地址为 rs 的通用寄存器的值小于等于零，那么发生转移。
* bne 指令：`bne rs, rt, offset` 如果地址为 rs 的通用寄存器的值不等于地址为 rt 的通用寄存器的值，那么发生转移。
* bltz 指令：`bltz rs, offset` 如果地址为 rs 的通用寄存器的值小于 0，那么发生转移。
* bltzal 指令：`bltzal rs, offset` 除了实现 bltz 指令中转移的功能外，还同时将转移指令后面第 2 条指令的地址作为返回地址，保存到通用寄存器 $31。
* bgez 指令：`bgez rs, offset` 如果地址为 rs 的通用寄存器的值大于等于零，那么发生转移。
* bgezal 指令：`bgezal rs, offset` 除了实现 bgez 指令中转移的功能外，还同时将转移指令后面第 2 条指令的地址作为返回地址，保存到通用寄存器 $31。
* bal 指令：`bal offset`，是 bgezal 的特殊形式，不需要单独实现。

### （3）指令判断流程图
<div align=center><img src=./Picture/3.png width = 50% ></div>


## 3、数据流图与系统结构
<div align=center><img src=./Picture/4.png width = 50% ></div>

* 情况一：PC 等于 PC+4。这属于一般情况，每个时钟周期 PC 加 4，指向下一条指令。
* 情况二：PC 保持不变。当流水线暂停的时候，就会发生这种情况，参考 chapter 7 中流水线暂停的实现。
* 情况三：PC 等于转移判断的结果。如果是转移指令，且满足转移条件，那么会将转移目标地址赋给 PC。

<div align=center><img src=./Picture/5.png width = 50% ></div>

* 如果处于译码阶段的指令是转移指令，并且满足转移条件，那么 ID 模块设置转移发生标志 branch_flag_o 为Branch，同时通 过branch_target_address_o 接口给出转移目的地址，送到 PC 模块，后者据此修改取指地址。
* 如果处于译码阶段的指令是转移指令，并且满足转移条件，那么 ID 模块还会设置 next_inst_in_delayslot_o 为InDelaySlot，表示下一条指令是延迟槽指令，其中 InDelaySlot 是一个宏定义。next_inst_in_delayslot_o 信号会送入 ID/EX 模块，并在下一个时钟周期通过 ID/EX 模块的 is_in_delayslot_o 接口送回到 ID 模块，ID 模块可以据此判断当前处于译码阶段的指令是否是延迟槽指令。
* 如果转移指令需要保存返回地址，那么 ID 模块还要计算返回地址，并通过 link_addr_o 接口输出，该值最终会传递到 EX 模块，作为要写入目的寄存器的值。



